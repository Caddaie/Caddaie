<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaddAIe - Professional Golf Caddie</title>
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Professional golf distance calculator with real-time GPS, weather, and elevation">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1a1a1a;
            --accent: #8B7355;
            --gold: #D4AF37;
            --cream: #FAF8F3;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F6F1;
            --bg-tertiary: #EFEFEC;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #E5E5E5;
            --shadow: rgba(0, 0, 0, 0.08);
            --success: #4A7C59;
            --danger: #B85450;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-primary);
            position: relative;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.05);
        }
        
        /* Header */
        .header {
            background: var(--bg-primary);
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--primary);
        }
        
        /* GPS Alert Box */
        .gps-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .gps-alert button {
            background: #856404;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Distance Display */
        .distance-section {
            background: var(--bg-secondary);
            padding: 40px 24px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .distance-label {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .distance-value {
            font-size: 84px;
            font-weight: 200;
            line-height: 1;
            color: var(--primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }
        
        .distance-unit {
            font-size: 24px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        
        .distance-raw {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-top: 12px;
        }
        
        /* GPS Status Card */
        .gps-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .gps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .gps-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gps-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
        }
        
        .gps-indicator.active {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 124, 89, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 124, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 124, 89, 0); }
        }
        
        .gps-info {
            display: grid;
            gap: 10px;
        }
        
        .gps-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .gps-label {
            color: var(--text-secondary);
        }
        
        .gps-value {
            font-weight: 500;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            gap: 12px;
            padding: 20px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--accent);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn.success {
            background: var(--success);
        }
        
        .btn.danger {
            background: var(--danger);
        }
        
        /* Weather Card */
        .weather-card {
            background: var(--cream);
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .weather-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .weather-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .weather-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .weather-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* Factors */
        .factors-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin: 20px;
        }
        
        .factor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .factor-item:last-child {
            border-bottom: none;
        }
        
        .factor-name {
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .factor-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--success);
        }
        
        .factor-value.negative {
            color: var(--danger);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); }
            to { transform: translate(-50%, 0); }
        }
        
        /* Debug Panel */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .debug-item {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div class="logo">CaddAIe</div>
            </div>
        </div>
        
        <!-- GPS Alert -->
        <div class="gps-alert" id="gpsAlert" style="display: none;">
            <strong>GPS Required</strong><br>
            <span id="gpsAlertText">This app needs your location to calculate distances</span><br>
            <button onclick="enableGPS()">Enable GPS</button>
        </div>
        
        <!-- Distance Display -->
        <div class="distance-section">
            <div class="distance-label">Adjusted Distance</div>
            <div>
                <span class="distance-value" id="adjustedDistance">---</span>
                <span class="distance-unit">yds</span>
            </div>
            <div class="distance-raw">GPS Distance: <span id="rawDistance">---</span> yards</div>
        </div>
        
        <!-- GPS Status Card -->
        <div class="gps-card">
            <div class="gps-header">
                <h3 class="gps-title">GPS Status</h3>
                <div class="gps-status">
                    <div class="gps-indicator" id="gpsIndicator"></div>
                    <span id="gpsStatusText">Initializing...</span>
                </div>
            </div>
            <div class="gps-info">
                <div class="gps-row">
                    <span class="gps-label">Your Location:</span>
                    <span class="gps-value" id="yourLocation">---</span>
                </div>
                <div class="gps-row">
                    <span class="gps-label">Pin Location:</span>
                    <span class="gps-value" id="pinLocation">---</span>
                </div>
                <div class="gps-row">
                    <span class="gps-label">Accuracy:</span>
                    <span class="gps-value" id="gpsAccuracy">---</span>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn" onclick="forceGPSRequest()">
                📍 Get My GPS Location
            </button>
            <button class="btn secondary" onclick="setPinLocation()">
                ⛳ Set Pin Location
            </button>
            <button class="btn secondary" onclick="updateWeatherData()">
                🌤️ Update Weather
            </button>
            <button class="btn danger" onclick="showDebugInfo()">
                🔧 Debug GPS Issues
            </button>
        </div>
        
        <!-- Weather Card -->
        <div class="weather-card">
            <h3 class="weather-header">Current Conditions</h3>
            <div class="weather-grid">
                <div class="weather-item">
                    <div class="weather-value" id="temperature">---</div>
                    <div class="weather-label">Temperature</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="windSpeed">---</div>
                    <div class="weather-label">Wind Speed</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="humidity">---</div>
                    <div class="weather-label">Humidity</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="elevation">---</div>
                    <div class="weather-label">Elevation</div>
                </div>
            </div>
        </div>
        
        <!-- Factors Card -->
        <div class="factors-card">
            <h3 style="margin-bottom: 15px;">Shot Adjustments</h3>
            <div id="factorsList">
                <div class="factor-item">
                    <span class="factor-name">Calculating...</span>
                    <span class="factor-value">---</span>
                </div>
            </div>
        </div>
        
        <!-- Debug Panel -->
        <div class="debug-panel" id="debugPanel" style="display: none;">
            <div class="debug-title">GPS Debug Information</div>
            <div id="debugInfo"></div>
        </div>
    </div>
    
    <script>
        // Global Variables
        let userLocation = null;
        let pinLocation = null;
        let watchId = null;
        let gpsAttempts = 0;
        
        // App State
        const appState = {
            distance: 0,
            adjustedDistance: 0,
            factors: {
                elevation: 0,
                wind: 0,
                temperature: 0,
                humidity: 0
            }
        };
        
        // Initialize App
        window.addEventListener('DOMContentLoaded', function() {
            console.log('CaddAIe GPS App Starting...');
            checkGPSSupport();
            
            // Try to get GPS immediately
            setTimeout(() => {
                forceGPSRequest();
            }, 1000);
        });
        
        // Check GPS Support
        function checkGPSSupport() {
            const debugInfo = {
                protocol: location.protocol,
                hostname: location.hostname,
                userAgent: navigator.userAgent,
                geolocationAvailable: 'geolocation' in navigator
            };
            
            console.log('GPS Support Check:', debugInfo);
            
            if (!('geolocation' in navigator)) {
                showGPSAlert('GPS not supported on this device');
                updateDebugInfo('GPS not supported by browser');
                return false;
            }
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showGPSAlert('HTTPS required for GPS. Please use https://');
                updateDebugInfo('HTTPS required but not detected');
                return false;
            }
            
            return true;
        }
        
        // Show GPS Alert
        function showGPSAlert(message) {
            const alert = document.getElementById('gpsAlert');
            const alertText = document.getElementById('gpsAlertText');
            alert.style.display = 'block';
            alertText.textContent = message;
        }
        
        // Force GPS Request
        async function forceGPSRequest() {
            console.log('Force GPS Request - Attempt', ++gpsAttempts);
            
            const statusText = document.getElementById('gpsStatusText');
            const indicator = document.getElementById('gpsIndicator');
            
            statusText.textContent = 'Requesting location...';
            
            if (!checkGPSSupport()) {
                return;
            }
            
            try {
                // Show loading
                showNotification('📍 Requesting GPS permission...');
                
                // Request with high accuracy
                const position = await new Promise((resolve, reject) => {
                    const options = {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    };
                    
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log('GPS Success:', pos);
                            resolve(pos);
                        },
                        (err) => {
                            console.error('GPS Error:', err);
                            reject(err);
                        },
                        options
                    );
                });
                
                // Success!
                handleGPSSuccess(position);
                
            } catch (error) {
                handleGPSError(error);
            }
        }
        
        // Handle GPS Success
        function handleGPSSuccess(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            // Update UI
            const indicator = document.getElementById('gpsIndicator');
            const statusText = document.getElementById('gpsStatusText');
            
            indicator.classList.add('active');
            statusText.textContent = 'GPS Active';
            
            // Hide alert
            document.getElementById('gpsAlert').style.display = 'none';
            
            // Update location display
            document.getElementById('yourLocation').textContent = 
                `${userLocation.lat.toFixed(4)}°, ${userLocation.lng.toFixed(4)}°`;
            document.getElementById('gpsAccuracy').textContent = 
                `±${Math.round(userLocation.accuracy)}m`;
            
            // Set default pin if needed
            if (!pinLocation) {
                pinLocation = {
                    lat: userLocation.lat + 0.0009, // ~100 yards
                    lng: userLocation.lng
                };
                document.getElementById('pinLocation').textContent = 
                    `${pinLocation.lat.toFixed(4)}°, ${pinLocation.lng.toFixed(4)}°`;
            }
            
            // Calculate distance
            calculateDistance();
            
            // Get weather
            updateWeatherData();
            
            // Start watching position
            startWatchingPosition();
            
            showNotification('✅ GPS location acquired!');
        }
        
        // Handle GPS Error
        function handleGPSError(error) {
            console.error('GPS Error Details:', error);
            
            const statusText = document.getElementById('gpsStatusText');
            let message = '';
            
            switch(error.code) {
                case 1:
                    message = 'Permission denied - Check browser settings';
                    showGPSAlert('Location access denied. Enable in browser settings.');
                    break;
                case 2:
                    message = 'Position unavailable';
                    showGPSAlert('GPS unavailable. Check device location settings.');
                    break;
                case 3:
                    message = 'Timeout - Try again';
                    showGPSAlert('GPS timeout. Make sure you have good signal.');
                    break;
                default:
                    message = 'Unknown error';
                    showGPSAlert('GPS error. Try again or check settings.');
            }
            
            statusText.textContent = message;
            updateDebugInfo(`GPS Error ${error.code}: ${error.message}`);
            showNotification(`❌ ${message}`);
        }
        
        // Start Watching Position
        function startWatchingPosition() {
            if (watchId) return;
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    document.getElementById('yourLocation').textContent = 
                        `${userLocation.lat.toFixed(4)}°, ${userLocation.lng.toFixed(4)}°`;
                    document.getElementById('gpsAccuracy').textContent = 
                        `±${Math.round(userLocation.accuracy)}m`;
                    
                    calculateDistance();
                },
                (error) => {
                    console.error('Watch position error:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000
                }
            );
        }
        
        // Calculate Distance
        function calculateDistance() {
            if (!userLocation || !pinLocation) {
                console.log('Missing location data');
                return;
            }
            
            // Haversine formula
            const R = 6371e3; // Earth radius in meters
            const φ1 = userLocation.lat * Math.PI/180;
            const φ2 = pinLocation.lat * Math.PI/180;
            const Δφ = (pinLocation.lat - userLocation.lat) * Math.PI/180;
            const Δλ = (pinLocation.lng - userLocation.lng) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            const distanceMeters = R * c;
            const distanceYards = Math.round(distanceMeters * 1.09361);
            
            appState.distance = distanceYards;
            document.getElementById('rawDistance').textContent = distanceYards;
            
            // Calculate adjusted distance
            calculateAdjustedDistance();
        }
        
        // Calculate Adjusted Distance
        function calculateAdjustedDistance() {
            let adjusted = appState.distance;
            
            // Add all factors
            Object.values(appState.factors).forEach(factor => {
                adjusted += factor;
            });
            
            appState.adjustedDistance = Math.max(0, adjusted);
            document.getElementById('adjustedDistance').textContent = appState.adjustedDistance || '---';
            
            // Update factors display
            updateFactorsDisplay();
        }
        
        // Update Weather Data
        async function updateWeatherData() {
            if (!userLocation) {
                showNotification('📍 Need GPS location for weather');
                return;
            }
            
            showNotification('🌤️ Updating weather...');
            
            try {
                // Try real API first
                const response = await fetch(`/api/weather?lat=${userLocation.lat}&lon=${userLocation.lng}`);
                const data = await response.json();
                
                if (data.main) {
                    // Real weather data
                    document.getElementById('temperature').textContent = `${Math.round(data.main.temp)}°F`;
                    document.getElementById('windSpeed').textContent = `${Math.round(data.wind.speed)} mph`;
                    document.getElementById('humidity').textContent = `${data.main.humidity}%`;
                    
                    // Calculate factors
                    appState.factors.temperature = Math.round((77 - data.main.temp) * 0.1);
                    appState.factors.wind = Math.round(data.wind.speed * 0.3);
                    
                    showNotification('✅ Weather updated');
                } else {
                    throw new Error('No weather data');
                }
                
            } catch (error) {
                console.error('Weather API error:', error);
                // Use simulated data
                simulateWeather();
            }
            
            // Get elevation
            getElevation();
            
            calculateAdjustedDistance();
        }
        
        // Simulate Weather (Fallback)
        function simulateWeather() {
            const temp = 65 + Math.random() * 20;
            const wind = 5 + Math.random() * 15;
            const humidity = 40 + Math.random() * 40;
            
            document.getElementById('temperature').textContent = `${Math.round(temp)}°F`;
            document.getElementById('windSpeed').textContent = `${Math.round(wind)} mph`;
            document.getElementById('humidity').textContent = `${Math.round(humidity)}%`;
            
            appState.factors.temperature = Math.round((77 - temp) * 0.1);
            appState.factors.wind = Math.round(wind * 0.3);
            
            showNotification('🌤️ Weather updated (simulated)');
        }
        
        // Get Elevation
        function getElevation() {
            // For now, simulate elevation
            const elevationFeet = -10 + Math.random() * 40;
            document.getElementById('elevation').textContent = `${elevationFeet > 0 ? '+' : ''}${Math.round(elevationFeet)} ft`;
            
            appState.factors.elevation = Math.round(elevationFeet * 0.33);
        }
        
        // Set Pin Location
        function setPinLocation() {
            if (!userLocation) {
                showNotification('📍 Get GPS location first');
                return;
            }
            
            const distance = prompt('Enter distance to pin in yards:', '150');
            if (!distance) return;
            
            const yards = parseInt(distance);
            if (isNaN(yards) || yards < 1 || yards > 999) {
                showNotification('❌ Invalid distance');
                return;
            }
            
            // Simple calculation - put pin north
            const meters = yards * 0.9144;
            const latOffset = meters / 111111;
            
            pinLocation = {
                lat: userLocation.lat + latOffset,
                lng: userLocation.lng
            };
            
            document.getElementById('pinLocation').textContent = 
                `${pinLocation.lat.toFixed(4)}°, ${pinLocation.lng.toFixed(4)}°`;
            
            calculateDistance();
            showNotification(`⛳ Pin set at ${yards} yards`);
        }
        
        // Update Factors Display
        function updateFactorsDisplay() {
            const factorsList = document.getElementById('factorsList');
            
            const factors = [
                { name: 'Elevation', value: appState.factors.elevation, unit: 'yds' },
                { name: 'Wind', value: appState.factors.wind, unit: 'yds' },
                { name: 'Temperature', value: appState.factors.temperature, unit: 'yds' },
                { name: 'Total Adjustment', value: Object.values(appState.factors).reduce((a, b) => a + b, 0), unit: 'yds' }
            ];
            
            factorsList.innerHTML = factors.map(factor => `
                <div class="factor-item">
                    <span class="factor-name">${factor.name}</span>
                    <span class="factor-value ${factor.value < 0 ? 'negative' : ''}">
                        ${factor.value > 0 ? '+' : ''}${factor.value} ${factor.unit}
                    </span>
                </div>
            `).join('');
        }
        
        // Show Debug Info
        function showDebugInfo() {
            const panel = document.getElementById('debugPanel');
            const info = document.getElementById('debugInfo');
            
            const debugData = {
                'Browser': navigator.userAgent.match(/iPhone|Android|iPad/) || 'Desktop',
                'Protocol': location.protocol,
                'Hostname': location.hostname,
                'GPS Available': 'geolocation' in navigator,
                'GPS Attempts': gpsAttempts,
                'User Location': userLocation ? `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}` : 'Not set',
                'Pin Location': pinLocation ? `${pinLocation.lat.toFixed(4)}, ${pinLocation.lng.toFixed(4)}` : 'Not set',
                'Distance': appState.distance + ' yards',
                'Adjusted': appState.adjustedDistance + ' yards'
            };
            
            info.innerHTML = Object.entries(debugData).map(([key, value]) => 
                `<div class="debug-item"><strong>${key}:</strong> ${value}</div>`
            ).join('');
            
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Update Debug Info
        function updateDebugInfo(message) {
            console.log('Debug:', message);
        }
        
        // Enable GPS (from alert)
        function enableGPS() {
            document.getElementById('gpsAlert').style.display = 'none';
            forceGPSRequest();
        }
        
        // Show Notification
        function showNotification(message) {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
